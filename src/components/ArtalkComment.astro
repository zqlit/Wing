---
import { ARTALK_CONFIG } from "../config";

interface Props {
  pageKey: string;
}
const { pageKey } = Astro.props;
---

<div class="text-center mt-8 w-full">
  <button
    id="artalk-btn"
    class="inline-flex items-center gap-1.5 cursor-pointer text-sm px-3 py-1.5 rounded-lg border border-gray-200 bg-gray-50/70 text-slate-700 transition-all duration-350 ease-in-out active:scale-95 dark:bg-slate-900/30 dark:text-slate-100 dark:border-slate-800 hover:bg-slate-100 dark:hover:bg-slate-900/50"
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0"></path>
    </svg>
    让我看看！都在聊什么
  </button>
  <div id="artalk-container" class="mt-4 w-full max-w-none" data-page-key={pageKey}></div>

  <script is:inline define:vars={{ artalkCfg: ARTALK_CONFIG }}>
    // artalkCfg 已由 define:vars 提供

    // 在页面加载时预加载本地覆盖样式
    const injectArtalkStyles = () => {
      if (!document.querySelector('link[href*="artalk.css"][data-override]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/src/styles/artalk.css';
        link.setAttribute('data-override', 'true');
        document.head.appendChild(link);
      }
    };

    // 使用事件委托，避免 View Transitions 下事件丢失
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('#artalk-btn');
      if (!btn) return;

      const container = document.getElementById('artalk-container');
      if (!container) return;

      // 检查是否已加载
      if (container.dataset.loaded === 'true') return;
      container.dataset.loaded = 'true';

      btn.style.opacity = '0';
      btn.style.transform = 'scale(0.92)';
      btn.style.pointerEvents = 'none';

      // 加载样式
      if (!document.querySelector('link[href*="Artalk.css"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = artalkCfg.cssUrl;
        document.head.appendChild(link);
      }

      // 加载并初始化 Artalk
      if (!window.Artalk) {
        const script = document.createElement('script');
        script.src = artalkCfg.jsUrl;
        script.onload = function () {
          // 脚本加载后重新注入覆盖样式
          setTimeout(() => {
            injectArtalkStyles();
            initArtalk(container);
          }, 50);
        };
        document.body.appendChild(script);
      } else {
        injectArtalkStyles();
        initArtalk(container);
      }

      function initArtalk(el) {
        const pageKey = el.dataset.pageKey || window.location.pathname;
        window.Artalk.init({
          el: el,
          server: artalkCfg.server,
          site: artalkCfg.site,
          pageKey: pageKey,
          pageTitle: document.title,
          locale: 'zh-CN',
        }).setDarkMode(document.documentElement.classList.contains('dark'));
      }
    });

    // 监听暗模式变更，同步更新 Artalk
    document.addEventListener('astro:before-swap', function () {
      if (window.Artalk) {
        setTimeout(() => {
          const isDark = document.documentElement.classList.contains('dark');
          window.Artalk.setDarkMode(isDark);
        }, 50);
      }
    });

    // 监听主题切换 - 通过 MutationObserver 监听 class 变化
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          if (window.Artalk) {
            const isDark = document.documentElement.classList.contains('dark');
            window.Artalk.setDarkMode(isDark);
          }
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class']
    });

    // 监听 localStorage 变化，实时同步主题
    window.addEventListener('storage', (e) => {
      if (e.key === 'theme' && window.Artalk) {
        const isDark = e.newValue === 'dark' || (e.newValue === null && window.matchMedia('(prefers-color-scheme: dark)').matches);
        window.Artalk.setDarkMode(isDark);
      }
    });

    // 路由切换重置
    document.addEventListener('astro:after-swap', function () {
      const btn = document.getElementById('artalk-btn');
      const container = document.getElementById('artalk-container');

      if (btn) {
        btn.style.opacity = '1';
        btn.style.transform = 'scale(1)';
        btn.style.pointerEvents = 'auto';
      }

      if (container) {
        container.innerHTML = '';
        delete container.dataset.loaded;
      }
    });
  </script>
</div>

