---
interface Props {
  pageKey: string;
}
const { pageKey } = Astro.props;
---

<div class="text-center mt-8">
  <button
    id="artalk-btn"
    class="inline-flex items-center gap-1.5 cursor-pointer text-sm px-3 py-1.5 rounded-lg border border-gray-200 bg-gray-50/70 text-slate-700 transition-all duration-350 ease-in-out active:scale-95 dark:bg-slate-900/30 dark:text-slate-100 dark:border-slate-800 hover:bg-slate-100 dark:hover:bg-slate-900/50"
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0"></path>
    </svg>
    让我看看！都在聊什么
  </button>
  <div id="artalk-container" class="mt-4" data-page-key={pageKey}></div>

  <script is:inline>
    // 使用事件委托，避免 View Transitions 下事件丢失
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('#artalk-btn');
      if (!btn) return;

      const container = document.getElementById('artalk-container');
      if (!container) return;

      // 检查是否已加载
      if (container.dataset.loaded === 'true') return;
      container.dataset.loaded = 'true';

      btn.style.opacity = '0';
      btn.style.transform = 'scale(0.92)';
      btn.style.pointerEvents = 'none';

      // 加载样式
      if (!document.querySelector('link[href*="Artalk.css"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/artalk/dist/Artalk.css';
        document.head.appendChild(link);
      }

      // 加载并初始化 Artalk
      if (!window.Artalk) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/artalk/dist/Artalk.js';
        script.onload = function() {
          initArtalk(container);
        };
        document.body.appendChild(script);
      } else {
        initArtalk(container);
      }

      function initArtalk(el) {
        const pageKey = el.dataset.pageKey || window.location.pathname;
        window.Artalk.init({
          el: el,
          server: "https://artalk.usj.cc",
          site: "伍比贰",
          pageKey: pageKey,
          pageTitle: document.title,
          locale: 'zh-CN'
        }).setDarkMode(document.documentElement.classList.contains('dark'));
      }
    });

    // 路由切换重置
    document.addEventListener('astro:after-swap', function() {
      const btn = document.getElementById('artalk-btn');
      const container = document.getElementById('artalk-container');
      
      if (btn) {
        btn.style.opacity = '1';
        btn.style.transform = 'scale(1)';
        btn.style.pointerEvents = 'auto';
      }
      
      if (container) {
        container.innerHTML = '';
        delete container.dataset.loaded;
      }
    });
  </script>
</div>