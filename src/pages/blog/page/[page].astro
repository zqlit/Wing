---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PostsLists from "../../../components/PostsLists.astro";
import { getCollection } from "astro:content";
import { PAGINATION_CONFIG } from "../../../config";

// 获取所有文章
const allPosts = (await getCollection("blog")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 分页配置
const POSTS_PER_PAGE = PAGINATION_CONFIG.postsPerPage;
const { page } = Astro.params;
const currentPage = parseInt(page || "1");

// 验证页码
if (currentPage < 1 || isNaN(currentPage)) {
  return Astro.redirect("/blog/");
}

const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);

if (currentPage > totalPages) {
  return Astro.redirect("/blog/");
}

const start = (currentPage - 1) * POSTS_PER_PAGE;
const posts = allPosts.slice(start, start + POSTS_PER_PAGE);

// 生成静态页面
export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const POSTS_PER_PAGE = PAGINATION_CONFIG.postsPerPage;
  const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);
  
  return Array.from({ length: totalPages - 1 }, (_, i) => ({
    params: { page: String(i + 2) }
  }));
}
---

<BaseLayout>
  <PostsLists posts={posts} />

  {/* 分页导航（圆形按钮，简约） */}
  <div class="flex items-center justify-center gap-2 mt-12 py-6">
    {Array.from({ length: totalPages }, (_, i) => {
      const pageNum = i + 1;
      const active = pageNum === currentPage;
      return (
        <a
          href={pageNum === 1 ? "/blog" : `/blog/page/${pageNum}`}
          class={`w-8 h-8 rounded-full flex items-center justify-center text-xs transition border ${
            active
              ? "bg-gray-900 text-white border-gray-900 dark:bg-gray-100 dark:text-gray-900 dark:border-gray-100"
              : "border-gray-300 text-gray-500 hover:border-gray-500 hover:text-gray-900 dark:border-gray-700 dark:text-gray-400 dark:hover:border-gray-500 dark:hover:text-gray-100"
          }`}
        >
          {pageNum}
        </a>
      );
    })}
  </div>
</BaseLayout>
