---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PostsLists from "../../../components/PostsLists.astro";
import { getCollection } from "astro:content";
import { PAGINATION_CONFIG } from "../../../config";

// 获取所有文章
const allPosts = (await getCollection("blog")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 分页配置
const POSTS_PER_PAGE = PAGINATION_CONFIG.postsPerPage;
const { page } = Astro.params;
const currentPage = parseInt(page || "1");

// 验证页码
if (currentPage < 1 || isNaN(currentPage)) {
  return Astro.redirect("/blog/");
}

const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);

if (currentPage > totalPages) {
  return Astro.redirect("/blog/");
}

const start = (currentPage - 1) * POSTS_PER_PAGE;
const posts = allPosts.slice(start, start + POSTS_PER_PAGE);

// 生成静态页面
export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const POSTS_PER_PAGE = PAGINATION_CONFIG.postsPerPage;
  const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);
  
  return Array.from({ length: totalPages - 1 }, (_, i) => ({
    params: { page: String(i + 2) }
  }));
}
---

<BaseLayout>
  <PostsLists posts={posts} />
  
  {/* 分页导航 */}
  <div class="flex items-center justify-center gap-1 mt-12 py-6">
    {currentPage > 1 && (
      <a href={currentPage === 2 ? "/blog" : `/blog/page/${currentPage - 1}`} class="px-2 py-1 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition">
        <i class="ri-arrow-left-s-line text-xl"></i>
      </a>
    )}
    
    <div class="flex gap-1 mx-2">
      {Array.from({ length: totalPages }, (_, i) => {
        const pageNum = i + 1;
        return (
          <a
            href={pageNum === 1 ? "/blog" : `/blog/page/${pageNum}`}
            class={`px-3 py-1 transition ${
              pageNum === currentPage
                ? "text-gray-900 dark:text-gray-100 border-b-2 border-gray-900 dark:border-gray-100"
                : "text-gray-500 dark:text-gray-500 hover:text-gray-900 dark:hover:text-gray-100"
            }`}
          >
            {pageNum}
          </a>
        );
      })}
    </div>
    
    {currentPage < totalPages && (
      <a href={`/blog/page/${currentPage + 1}`} class="px-2 py-1 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition">
        <i class="ri-arrow-right-s-line text-xl"></i>
      </a>
    )}
  </div>
</BaseLayout>
